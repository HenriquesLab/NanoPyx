name: test-nightly
# does a massive check, every night

on:
  schedule:
    - cron: "0 23 * * *"

  # creates a button
  workflow_dispatch:
    inputs:
      logLevel:
        description: "Log level"
        required: true
        default: "warning"
        type: choice
        options:
          - info
          - warning
          - debug

jobs:
  build_wheels:
    runs-on: [self-hosted, deepthought]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install Python's for Nox
        uses: wntrblm/nox@2022.8.7
        with:
          python-versions: "3.8, 3.9, 3.10, 3.11"
      - name: Run Nox - build_wheel build_sdist
        run: |
          python3 -m pip install pipx
          pipx run nox --sessions build_wheel build_sdist
        env:
          LOG_LEVEL: ${{ github.event.inputs.logLevel }}
      - name: Archive Wheels
        uses: actions/upload-artifact@v3
        with:
          name: wheels
          path: wheelhouse/*.whl
          retention-days: 15
      - name: Save wheels to cache
        id: cache-wheels-save
        uses: actions/cache@v3
        with:
          path: wheelhouse
          key: ${{ runner.os }}-wheelhouse-${{ hashFiles('**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-wheelhouse-

  test_wheels:
    needs: build_wheels
    runs-on: [self-hosted, deepthought]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Restore cached wheels
        id: cache-wheels-restore
        uses: actions/cache/restore@v3
        with:
          path: wheelhouse
          key: ${{ runner.os }}-wheelhouse-${{ hashFiles('**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-wheelhouse-
      - name: Install Python's for Nox
        uses: wntrblm/nox@2022.8.7
        with:
          python-versions: "3.8, 3.9, 3.10, 3.11"
      - name: Run Nox - tests_on_wheels
        run: |
          python3 -m pip install pipx
          pipx run nox --sessions tests_on_wheels
        env:
          LOG_LEVEL: ${{ github.event.inputs.logLevel }}

  deploy_doc:
    runs-on: [self-hosted, deepthought]
    # only run if main branch
    if: github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install Python's for Nox
        uses: wntrblm/nox@2022.8.7
        with:
          python-versions: "3.10"
      - name: Run Nox - generate_docs
        run: |
          python3 -m pip install pipx
          pipx run nox --sessions generate_docs
      - id: deployment
        uses: actions/deploy-pages@v1

  generate_movie:
    runs-on: [self-hosted, deepthought]
    steps:
      - name: Generate movie
        run: |
          xvfb-run gource --output-custom-log repo-activity.log
          python3 -c "txt=open('repo-activity.log').read();txt=txt.replace('Bruno Manuel Santos Saraiva', 'Bruno Saraiva').replace('inesmcunha', 'Inês Cunha').replace('antmsbrito', 'António Brito');open('repo-activity.log', 'w').write(txt)"
          xvfb-run gource -a 1 -s 1 -c 2 --user-image-dir /home/docker/NanoPyx/faces repo-activity.log -1280x720 -o - | ffmpeg -y -r 60 -f image2pipe -vcodec ppm -i - -pix_fmt yuv420p gource.mp4
      - name: Archive generated movie
        uses: actions/upload-artifact@v3
        with:
          name: gource-movie
          path: gource.mp4
          retention-days: 3

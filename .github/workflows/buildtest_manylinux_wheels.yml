name: Build and Test manylinux wheels

on: workflow_dispatch

jobs:
    build_wheels:
        uses: RalfG/python-wheels-manylinux-build@v0.7.1
        with:
            python-versions: 'cp39-cp39 cp310-cp310 cp311-cp311'

    test_wheels:
        name: Test wheels on Python ${{ matrix.python }}-${{ matrix.platform_id }}-${{ matrix.manylinux_image }}
        runs-on: ${{ matrix.os }}
        needs: build_wheels
        strategy:
            matrix:
                include:
                - os: ubuntu-latest
                  python: 39
                - os: ubuntu-latest
                  python: 310
                - os: ubuntu-latest
                  python: 311
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                python-version: '3.9'
            - name: Build wheels
              run: python -m cibuildwheel --output-dir wheelhouse
              # to supply options, put them in 'env', like:
              env:
                CIBW_BUILD: cp${{ matrix.python }}-${{ matrix.platform_id }}
                CIBW_ARCHS: all
                CIBW_BUILD_VERBOSITY: 1
                CIBW_TEST_COMMAND: "pytest {project}/tests"
            - name: Test wheels
              continue-on-error: true
              run: |
                python -m pip install --upgrade pip
                python -m pip install pipx
                python -m pip install nox
                python -m nox --sessions test_wheel
                  
            - uses: actions/upload-artifact@v4
              with:
                path: ./wheelhouse/*.whl